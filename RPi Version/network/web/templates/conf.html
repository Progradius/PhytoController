{% extends "base.html" %}

{% block content %}
<h1>Configuration</h1><hr>

<div class="scroll-container">
  {% for section in sections %}
    <div class="card">
      <form method="post" action="/conf">
        <h2>{{ section.title }}</h2><hr>

        {% if section.type == "merge" %}
          {% for field in section.fields %}
            <label for="{{ field.name }}">{{ field.label }}</label>
            {{ field.input_html|safe }}
          {% endfor %}

        {% elif section.type == "motor" %}
          <label>Motor Mode</label>
          <div class="switch-group" data-target="Motor">
            <input type="radio" id="motor_manual" name="Motor_mode_switch" value="manual" {% if section.mode == 'manual' %}checked{% endif %}>
            <label class="switch-label" for="motor_manual">Manual</label>

            <input type="radio" id="motor_auto" name="Motor_mode_switch" value="auto" {% if section.mode == 'auto' %}checked{% endif %}>
            <label class="switch-label" for="motor_auto">Auto</label>

            <input type="hidden" name="Motor.motor_mode" id="Motor_mode_input" value="{{ section.mode }}">
          </div>

          <div id="Motor_manual_fields">
            <label for="Motor.motor_user_speed">Motor User Speed</label>
            <input type="number" name="Motor.motor_user_speed" min="0" max="4" value="{{ section.user_speed }}">
          </div>

        {% elif section.type == "cyclic" %}
          <label>Mode</label>
          <div class="switch-group" data-target="{{ section.id }}">
            <input type="radio" id="{{ section.id }}_journalier" name="{{ section.id }}_mode_switch" value="journalier" {% if section.mode == 'journalier' %}checked{% endif %}>
            <label class="switch-label" for="{{ section.id }}_journalier">Journalier</label>

            <input type="radio" id="{{ section.id }}_sequentiel" name="{{ section.id }}_mode_switch" value="séquentiel" {% if section.mode == 'séquentiel' %}checked{% endif %}>
            <label class="switch-label" for="{{ section.id }}_sequentiel">Séquentiel</label>

            <input type="hidden" name="{{ section.alias }}.mode" id="{{ section.id }}_mode_input" value="{{ section.mode }}">
          </div>

          <div id="{{ section.id }}_journalier_fields">
            {% for field in section.journalier_fields %}
              <label for="{{ field.name }}">{{ field.label }}</label>
              {{ field.input_html|safe }}
            {% endfor %}
          </div>

          <div id="{{ section.id }}_séquentiel_fields">
            {% for field in section.sequentiel_fields %}
              <label for="{{ field.name }}">{{ field.label }}</label>
              {{ field.input_html|safe }}
            {% endfor %}
          </div>

        {% elif section.type == "heater" %}
          <label>Heater</label>
          <div class="switch-group" data-target="Heater">
            <input type="radio" id="heater_enabled" name="Heater_mode_switch" value="enabled" {% if section.enabled == 'enabled' %}checked{% endif %}>
            <label class="switch-label" for="heater_enabled">Enabled</label>

            <input type="radio" id="heater_disabled" name="Heater_mode_switch" value="disabled" {% if section.enabled == 'disabled' %}checked{% endif %}>
            <label class="switch-label" for="heater_disabled">Disabled</label>

            <input type="hidden" name="Heater_Settings.enabled" id="Heater_mode_input" value="{{ section.enabled }}">
          </div>

        {% else %}
          {% for field in section.fields %}
            <label for="{{ field.name }}">{{ field.label }}</label>
            {{ field.input_html|safe }}
          {% endfor %}
        {% endif %}

        <button type="submit" class="button_param">Save</button>
      </form>
    </div>
  {% endfor %}
</div>

<style>
.switch-group {
  margin: 10px 0;
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  align-items: center;
}
.switch-label {
  padding: 8px 16px;
  border: 2px solid #00FF88;
  cursor: pointer;
  font-family: 'VisitorTT1BRK', monospace;
  color: #00FF88;
  background: #000;
  text-transform: uppercase;
  transition: 0.2s;
}
.switch-group input[type="radio"] {
  display: none;
}
.switch-group input[type="radio"]:checked + .switch-label {
  background: #00FF88;
  color: #000;
}
@media (max-width: 768px) {
  .switch-label {
    display: block;
    width: 100%;
    text-align: center;
  }
}
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll(".switch-group").forEach(group => {
    const target = group.getAttribute("data-target");
    const hiddenInput = document.getElementById(target + "_mode_input");

    group.querySelectorAll('input[type="radio"]').forEach(radio => {
      radio.addEventListener("change", () => {
        const selected = group.querySelector('input[type="radio"]:checked').value;
        if (hiddenInput) hiddenInput.value = selected;

        if (target === "Motor") {
          const manualDiv = document.getElementById("Motor_manual_fields");
          if (manualDiv) manualDiv.style.display = (selected === "manual") ? "block" : "none";
        } else if (target.startsWith("Cyclic")) {
          const jDiv = document.getElementById(target + "_journalier_fields");
          const sDiv = document.getElementById(target + "_séquentiel_fields");
          if (jDiv && sDiv) {
            jDiv.style.display = (selected === "journalier") ? "block" : "none";
            sDiv.style.display = (selected === "séquentiel") ? "block" : "none";
          }
        }
      });
    });

    // Affichage initial
    const checked = group.querySelector('input[type="radio"]:checked');
    if (checked) checked.dispatchEvent(new Event("change"));
  });
});
</script>
{% endblock %}
